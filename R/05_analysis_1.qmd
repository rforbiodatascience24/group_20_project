## PCA

#### Libraries

```{r}
#| label: load-libraries
#| message: False
#| warning: False

library("tidyverse")
library("broom")  # devtools::install_github("tidymodels/broom")
library("cowplot")
library("ggrepel")
```

#### Data load

```{r}
#| label: load-metadata

data_pheno <- read.csv("../data/03_metadata_aug.csv")

# We want patients as row names, so we convert the tibble to a dataframe and names the rows
data_pheno <- data.frame(data_pheno) |> 
  column_to_rownames("source_name")
```

```{r}
#| label: load-counts

data_counts.total <- read.csv("../data/03_count_data_wide_aug.csv")

# We want genes as row names, so we convert the tibble to a dataframe and names the rows
data_counts <- data.frame(data_counts.total) |>
  dplyr::select(-gene_id, -gene_symbol, -transcript_ID)

colnames(data_counts) <- colnames(data_counts) |> 
  substring(2)

# The output of the mapping algorithm they use is an estimated number of reads mapped to each gene. It is a float while we need an integer. We will then convert it.
data_counts <- data_counts |> 
  mutate(across(where(is.numeric), as.integer))
```

We would like to:

1.  Look at the data in PC coordinates.

2.  Look at the rotation matrix.

3.  Look at the variance explained by each PC.

#### The data in PC coordinates

```{r}
#| label: applying-pca

pca_fit <- data_counts |>
  scale() |> # scaling data
  t() |> # transpose data
  prcomp() # make the PCA

pca_fit |>
  augment(metadata) |> # add metadata
  ggplot(aes(x = .fittedPC1, 
             y = .fittedPC2, 
             shape=clinical_information,
             col=disease, 
             label=source_name)) + 
    geom_point() + 
    labs(title = "PCA of the expression of patients",
         x = "PC1" , 
         y = "PC2", 
         color = "Disease", 
         shape = "Clinical information") +
    theme(plot.title = element_text(hjust = 0.5))
```

#### The rotation matrix

```{r}
#| label: rotation-matrix

# define arrow style for plotting
arrow_style <- arrow(
  angle = 20, 
  ends = "first", 
  type = "closed", 
  length = grid::unit(8, "pt")
)

# plot rotation matrix
pca_fit |>
  tidy(matrix = "rotation") |>
  pivot_wider(names_from = "PC", 
              names_prefix = "PC", 
              values_from = "value") |>
  ggplot(aes(PC1, PC2)) +
  geom_segment(xend = 0, 
               yend = 0, 
               arrow = arrow_style) +
  geom_text(
    aes(label = column),
    hjust = 1, nudge_x = -0.02, 
    color = "#56B4E9"
  ) +
  coord_fixed()
```

#### The variance by each PC

```{r}
#| label: variance-of-components

pca_fit |>
  tidy(matrix = "eigenvalues") |>
  ggplot(aes(PC, percent)) +
  geom_col(fill = "#56B4E9", alpha = 0.8) +
  scale_x_continuous(breaks = 1:9) +
  scale_y_continuous(
    trans = "log2",
    labels = scales::percent_format(),
    expand = expansion(mult = c(0, 0.01))
  ) +
  theme_minimal_hgrid(12)
```
