---
title: "GSEA"
author: Antoine Andréoletti, Olivier Gaufrès, Amy Surry, Lea Skytthe, Trine Søgaard
format:
  html:
    embed-resources: true
editor: visual
---

# Gene Set Enrichment Analysis (GSEA)

## Load libraries

```{r}
#| message: False

library("msigdbr")
library("clusterProfiler")
library("tidyverse")
```

## Load data

```{r}
res_df <- read.csv("../data/03_DESeq2_results-normal.csv")
```

## Data preparation

To perform Gene Set Enrichment Analysis we have to prepare data by ranking the genes and creating gene sets.

To rank the genes, we use "stat" column from the DESeq2 results. The stat column represents the test statistic and provides a standardized measure of how differentially expressed each gene is.

Furthermore, we remove potentially missing values.

```{r}
# Create list of ranked genes including names
res_df <- res_df |> 
  mutate(gene_symbol = na_if(gene_symbol, '')) |> 
  drop_na(stat, gene_symbol) |> 
  distinct(gene_symbol, .keep_all = TRUE) |> 
  arrange(desc(stat))

ranked_genes <- res_df |> 
  pull(stat)

gene_symbols <- res_df |> 
  pull(gene_symbol)
names(ranked_genes) <- gene_symbols
```

## Gene Set Enrichment Analysis

Before performing the GSEA, we need to divide the genes into gene sets. Using the msigdbr package, the gene sets are fetched. We use category "C5" meaning gene ontology (GO) terms.

```{r}
# Get gene sets
gene_sets <- msigdbr(species = "Homo sapiens", category = "C5")

# Reorganize gene sets 
gene_sets <- split(x = gene_sets$gene_symbol, f = gene_sets$gs_name)
```

From this we get the variable gene_sets, which is a named list, where each entry is a gene set (identified by gs_name) containing a vector of gene symbols.

To perform the GSEA, we use the fgsea package. The function tests each gene set for significant enrichment in high- or low-ranking genes.

Pathways specifies the gene sets to be tested (the list created above) and stats provides the ranked list of genes based on the stat values (test statistic) from differential expression.

```{r}
#| message: false
#| error: false

gsea_results <- GSEA(
  geneList = ranked_genes, # Ordered ranked gene list
  minGSSize = 25, # Minimum gene set size
  maxGSSize = 500, # Maximum gene set set
  pvalueCutoff = 0.05, # p-value cutoff
  eps = 0, # Boundary for calculating the p-value
  seed = TRUE, # Set seed to make results reproducible
  pAdjustMethod = "BH", # Benjamini-Hochberg correction
  TERM2GENE = dplyr::select(
    gene_sets,
    gs_name,
    gene_symbol
  )
)
```

Now we want to look further into the top 5 most significantly enriched pathways identified by fgsea.

```{r}
topPathways <- gsea_results |> 
  dplyr::arrange(p.adjust) |> 
  dplyr::slice(1:5)
```

```{r}
ggplot(topPathways, 
       mapping = aes(x = reorder(ID, NES), 
                     y = NES)) +
  geom_col() +
  coord_flip() +
  labs(x = "Pathway", 
       y = "Normalized Enrichment Score (NES)", 
       title = "Top 5 Enriched Pathways") +
  theme_minimal()
```
